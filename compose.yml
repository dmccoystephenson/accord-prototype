version: '3.8'

services:
  # Backend service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${BACKEND_CONTAINER_NAME:-accord-backend}
    ports:
      - "${BACKEND_PORT:-8080}:${SERVER_PORT:-8080}"
    environment:
      # Application configuration
      - SPRING_APPLICATION_NAME=${SPRING_APPLICATION_NAME:-accord-chat}
      - SERVER_PORT=${SERVER_PORT:-8080}
      
      # Database configuration (H2 in-memory)
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:h2:mem:chatdb}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=${SPRING_DATASOURCE_DRIVER_CLASS_NAME:-org.h2.Driver}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-sa}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-}
      
      # JPA configuration
      - SPRING_JPA_DATABASE_PLATFORM=${SPRING_JPA_DATABASE_PLATFORM:-org.hibernate.dialect.H2Dialect}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO:-create-drop}
      - SPRING_JPA_SHOW_SQL=${SPRING_JPA_SHOW_SQL:-false}
      
      # H2 Console
      - SPRING_H2_CONSOLE_ENABLED=${SPRING_H2_CONSOLE_ENABLED:-true}
      - SPRING_H2_CONSOLE_PATH=${SPRING_H2_CONSOLE_PATH:-/h2-console}
      
      # CORS configuration
      # For production, set to specific domains
      - APP_CORS_ALLOWED_ORIGINS=${APP_CORS_ALLOWED_ORIGINS:-*}
      
      # Validation configuration
      - APP_MESSAGE_MAX_LENGTH=${APP_MESSAGE_MAX_LENGTH:-1000}
      - APP_USERNAME_MAX_LENGTH=${APP_USERNAME_MAX_LENGTH:-50}
      - APP_USERNAME_MIN_LENGTH=${APP_USERNAME_MIN_LENGTH:-3}
    
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:$${SERVER_PORT:-8080}/api/messages"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - accord-network
    
    restart: unless-stopped

  # Web Application service
  webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: ${WEBAPP_CONTAINER_NAME:-accord-webapp}
    ports:
      - "${WEBAPP_PORT:-3000}:${WEBAPP_SERVER_PORT:-3000}"
    environment:
      # Application configuration
      - SPRING_APPLICATION_NAME=${WEBAPP_SPRING_APPLICATION_NAME:-accord-webapp}
      - SERVER_PORT=${WEBAPP_SERVER_PORT:-3000}
      
      # Backend configuration (server-side, internal Docker network)
      # Use service name for internal communication
      - ACCORD_BACKEND_URL=${ACCORD_BACKEND_URL:-http://backend:8080}
      - ACCORD_BACKEND_WS_URL=${ACCORD_BACKEND_WS_URL:-http://backend:8080/ws}
      
      # Backend configuration (client-side, browser access)
      # Must be accessible from the user's browser
      # Use DOCKER_HOST_IP variable for flexible network access
      # For local development: localhost
      # For network access: your machine's IP (e.g., 192.168.1.100)
      # For production: your public domain
      - DOCKER_HOST_IP=${DOCKER_HOST_IP:-localhost}
      - ACCORD_BACKEND_CLIENT_URL=${ACCORD_BACKEND_CLIENT_URL:-http://localhost:8080}
      - ACCORD_BACKEND_CLIENT_WS_URL=${ACCORD_BACKEND_CLIENT_WS_URL:-http://localhost:8080/ws}
    
    depends_on:
      backend:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:$${SERVER_PORT:-3000}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - accord-network
    
    restart: unless-stopped

networks:
  accord-network:
    driver: bridge
